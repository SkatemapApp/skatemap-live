#!/bin/bash

# Pre-commit hook to format Scala, Go, and shell files
# This hook runs scalafmt on Scala files, goimports on Go files, and shfmt on shell files

set -e

# Check if there are any staged Scala, Go, or shell files
staged_scala_files=$(git diff --cached --name-only --diff-filter=ACM | grep '\.scala$' || true)
staged_go_files=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)
staged_sh_files=$(git diff --cached --name-only --diff-filter=ACM | grep '\.sh$' || true)

# Exit early only if no Scala, Go, or shell files are staged
if [ -z "$staged_scala_files" ] && [ -z "$staged_go_files" ] && [ -z "$staged_sh_files" ]; then
  exit 0
fi

# Format Scala files if any are staged
if [ -n "$staged_scala_files" ]; then
  echo "Running scalafmt on staged Scala files..."

  # Find the sbt project directory (services/api)
  sbt_dir=""
  if [ -d "services/api" ] && [ -f "services/api/build.sbt" ]; then
    sbt_dir="services/api"
  elif [ -f "build.sbt" ]; then
    sbt_dir="."
  fi

  if [ -z "$sbt_dir" ]; then
    echo "Warning: Could not find sbt project directory, skipping scalafmt"
  elif ! command -v sbt &>/dev/null; then
    echo "Warning: sbt not found in PATH, skipping scalafmt"
  else
    scalafmt_output=$(cd "$sbt_dir" && sbt scalafmtAll 2>&1) || {
      echo "Error: scalafmt failed" >&2
      echo "$scalafmt_output" | grep -iE "(error|failed|exception)" >&2
      exit 1
    }
  fi

  # Check if scalafmt made any changes to staged files
  changes_made=false
  for file in $staged_scala_files; do
    if git diff --name-only | grep -q "^$file$"; then
      changes_made=true
      echo "Formatted: $file"
      # Re-add the formatted file to the staging area
      git add "$file"
    fi
  done

  if [ "$changes_made" = true ]; then
    echo "Scala files have been formatted and re-staged."
    echo "Please review the changes and commit again if needed."
  fi

  echo "Pre-commit scalafmt check completed successfully."
fi

# Format Go files if any are staged
if [ -n "$staged_go_files" ]; then
  echo "Running goimports on staged Go files..."

  if ! command -v goimports &>/dev/null; then
    echo "Error: goimports not found in PATH"
    if [ -f "$HOME/go/bin/goimports" ]; then
      echo "goimports is installed at ~/go/bin/goimports but not in PATH"
      echo "Add to your shell profile: export PATH=\"\$HOME/go/bin:\$PATH\""
    else
      echo "Install with: cd tools/load-testing && make install-tools"
      echo "Then ensure ~/go/bin is in your PATH"
    fi
    exit 1
  fi

  for file in $staged_go_files; do
    if [ -f "$file" ]; then
      goimports -w "$file"
    fi
  done

  go_changes_made=false
  for file in $staged_go_files; do
    if git diff --name-only | grep -q "^$file$"; then
      go_changes_made=true
      echo "Formatted: $file"
      git add "$file"
    fi
  done

  if [ "$go_changes_made" = true ]; then
    echo "Go files have been formatted and re-staged."
  fi

  echo "Pre-commit goimports check completed successfully."
fi

# Format shell files if any are staged
if [ -n "$staged_sh_files" ]; then
  echo "Running shfmt on staged shell files..."

  if ! command -v shfmt &>/dev/null; then
    echo "Error: shfmt not found in PATH"
    echo "Install with: brew install shfmt"
    echo "Or on Linux: snap install shfmt or download from https://github.com/mvdan/sh"
    exit 1
  fi

  for file in $staged_sh_files; do
    if [ -f "$file" ]; then
      shfmt -i 2 -w "$file"
    fi
  done

  sh_changes_made=false
  for file in $staged_sh_files; do
    if git diff --name-only | grep -q "^$file$"; then
      sh_changes_made=true
      echo "Formatted: $file"
      git add "$file"
    fi
  done

  if [ "$sh_changes_made" = true ]; then
    echo "Shell files have been formatted and re-staged."
  fi

  echo "Pre-commit shfmt check completed successfully."
fi

exit 0
