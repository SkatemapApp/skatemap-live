#!/bin/bash

# Pre-commit hook to format Scala and Go files
# This hook runs scalafmt on Scala files and goimports on Go files

set -e

# Check if there are any staged Scala or Go files
staged_scala_files=$(git diff --cached --name-only --diff-filter=ACM | grep '\.scala$' || true)
staged_go_files=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

# Exit early only if neither Scala nor Go files are staged
if [ -z "$staged_scala_files" ] && [ -z "$staged_go_files" ]; then
    exit 0
fi

# Format Scala files if any are staged
if [ -n "$staged_scala_files" ]; then
    echo "Running scalafmt on staged Scala files..."

    # Run scalafmt on the project
    sbt scalafmtAll > /dev/null 2>&1

    # Check if scalafmt made any changes to staged files
    changes_made=false
    for file in $staged_scala_files; do
        if git diff --name-only | grep -q "^$file$"; then
            changes_made=true
            echo "Formatted: $file"
            # Re-add the formatted file to the staging area
            git add "$file"
        fi
    done

    if [ "$changes_made" = true ]; then
        echo "Scala files have been formatted and re-staged."
        echo "Please review the changes and commit again if needed."
    fi

    echo "Pre-commit scalafmt check completed successfully."
fi

# Format Go files if any are staged
if [ -n "$staged_go_files" ]; then
    echo "Running goimports on staged Go files..."

    if ! command -v goimports &> /dev/null; then
        echo "Error: goimports not found in PATH"
        if [ -f "$HOME/go/bin/goimports" ]; then
            echo "goimports is installed at ~/go/bin/goimports but not in PATH"
            echo "Add to your shell profile: export PATH=\"\$HOME/go/bin:\$PATH\""
        else
            echo "Install with: cd tools/load-testing && make install-tools"
            echo "Then ensure ~/go/bin is in your PATH"
        fi
        exit 1
    fi

    for file in $staged_go_files; do
        if [ -f "$file" ]; then
            goimports -w "$file"
        fi
    done

    go_changes_made=false
    for file in $staged_go_files; do
        if git diff --name-only | grep -q "^$file$"; then
            go_changes_made=true
            echo "Formatted: $file"
            git add "$file"
        fi
    done

    if [ "$go_changes_made" = true ]; then
        echo "Go files have been formatted and re-staged."
    fi

    echo "Pre-commit goimports check completed successfully."
fi

exit 0