name: Shell Script Quality
permissions:
  contents: read

on:
  push:
    branches: [ master ]
    paths:
      - '**/*.sh'
      - 'scripts/git-hooks/**'
      - '.github/workflows/shell.yml'
  pull_request:
    branches: [ master ]
    paths:
      - '**/*.sh'
      - 'scripts/git-hooks/**'
      - '.github/workflows/shell.yml'

jobs:
  quality:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v5

    - name: Install shfmt
      run: |
        # Pin to v3.8.0 for reproducible builds - update quarterly
        wget -O /tmp/shfmt https://github.com/mvdan/sh/releases/download/v3.8.0/shfmt_v3.8.0_linux_amd64
        chmod +x /tmp/shfmt
        sudo mv /tmp/shfmt /usr/local/bin/shfmt

    - name: Install shellcheck
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck

    - name: Check shell script formatting
      run: |
        echo "Checking shell script formatting..."
        shfmt -i 2 -d .

    - name: Lint shell scripts
      run: |
        echo "Linting shell scripts..."
        # Note: SC1091 (can't follow source) is acceptable - test scripts source files dynamically
        find . -name "*.sh" -type f -exec shellcheck {} +
        shellcheck scripts/git-hooks/pre-commit scripts/git-hooks/commit-msg
